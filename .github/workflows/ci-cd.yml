name: CI/CD Pipeline to AWS 

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # --- 필요한 환경 변수 (본인 값으로 수정) ---
  AWS_REGION: ap-southeast-2
  # ECR
  ECR_BACKEND_REPOSITORY: chatbot-backend
  ECR_FRONTEND_REPOSITORY: chatbot-frontend
  # Lambda (Backend)
  LAMBDA_FUNCTION_NAME: chatbot-backend-lambda
  # ECS (Frontend) 
  ECS_CLUSTER_NAME: chatbot-ec2-cluster       # 기존 클러스터 이름
  ECS_FRONTEND_SERVICE_NAME: frontend-service # 새로 만들 프론트엔드 서비스 이름
  ECS_FRONTEND_TASK_DEFINITION: frontend-task-definition # 새로 만들 프론트엔드 작업 정의 이름
  CONTAINER_FRONTEND_NAME: frontend-container # 프론트엔드 작업 정의 내부의 컨테이너 이름

permissions:
  id-token: write # AWS OIDC 인증에 필요
  contents: read  # 코드 체크아웃에 필요

jobs:
  test: # 백엔드 코드 테스트 작업 (기존과 동일)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests (if available)
        run: |
          cd backend
          echo "Tests placeholder - add your tests here"

  build-backend: # 백엔드 이미지 빌드 및 푸시
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      image_uri: ${{ steps.set-output-uri.outputs.backend_uri }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Define backend image URI
        id: define-uri
        run: |
          echo "BACKEND_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.BACKEND_URI }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          provenance: false
          sbom: false
      - name: Set job output
        id: set-output-uri
        run: |
          echo "backend_uri=${{ env.BACKEND_URI }}" >> $GITHUB_OUTPUT

  build-frontend: # 프론트엔드 이미지 빌드 및 푸시
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      image_uri: ${{ steps.set-output-uri.outputs.frontend_uri }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Define frontend image URI
        id: define-uri
        run: |
          echo "FRONTEND_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.FRONTEND_URI }}
          platforms: linux/amd64 # EC2(amd64)용 아키텍처 명시
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          build-args: |
            DEBIAN_FRONTEND=noninteractive
          outputs: type=registry
      - name: Set job output
        id: set-output-uri
        run: |
          echo "frontend_uri=${{ env.FRONTEND_URI }}" >> $GITHUB_OUTPUT

  deploy-hybrid: # 배포 작업 이름 변경
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code # ECS 배포에도 코드 체크아웃 필요
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # --- 1. 백엔드: Lambda 함수 코드 업데이트 ---
      - name: Update Backend Lambda function code
        id: update-lambda
        run: |
          echo "Updating Lambda function ${{ env.LAMBDA_FUNCTION_NAME }} with image ${{ needs.build-backend.outputs.image_uri }}"
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri ${{ needs.build-backend.outputs.image_uri }}
      
      - name: Wait for code update to complete
        run: |
          echo "Waiting for Lambda function code update to complete..."
          aws lambda wait function-updated-v2 --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          echo "Code update completed!"
          
          # 추가 대기 시간 (안전을 위해)
          echo "Additional 30 seconds wait for stability..."
          sleep 30
          
          # 상태 확인
          echo "Current Lambda function status:"
          aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query 'Configuration.{State:State,LastUpdateStatus:LastUpdateStatus,StateReason:StateReason,StateReasonCode:StateReasonCode}'
      
      - name: Update Lambda function configuration
        run: |
          echo "Updating Lambda function configuration..."
          
          # 환경 변수 JSON 파일 생성
          cat > env_vars.json << EOF
          {
            "Variables": {
              "ENVIRONMENT": "production",
              "LOG_LEVEL": "INFO",
              "HF_HOME": "/tmp/.cache/huggingface",
              "TRANSFORMERS_CACHE": "/tmp/.cache/huggingface",
              "SENTENCE_TRANSFORMERS_HOME": "/tmp/.cache/sentence-transformers",
              "PINECONE_API_KEY_PARAM": "/chatbot/prod/PINECONE_API_KEY",
              "PINECONE_INDEX_NAME_PARAM": "/chatbot/prod/PINECONE_INDEX_NAME",
              "HYPERCLOVA_API_KEY_PARAM": "/chatbot/prod/HYPERCLOVA_API_KEY"
            }
          }
          EOF
          
          aws lambda update-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --memory-size 1024 \
            --timeout 300 \
            --environment file://env_vars.json
      
      - name: Wait for configuration update to complete
        run: |
          echo "Waiting for Lambda function configuration update to complete..."
          aws lambda wait function-updated-v2 --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          echo "Configuration update completed!"
          
          # 추가 대기 시간
          echo "Additional 30 seconds wait for stability..."
          sleep 30
      
      - name: Final Lambda function status check
        run: |
          echo "Final Lambda function status:"
          aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query 'Configuration.{State:State,LastUpdateStatus:LastUpdateStatus,StateReason:StateReason,StateReasonCode:StateReasonCode,LastModified:LastModified}'

      # --- 2. 프론트엔드: ECS 서비스 업데이트 ---
      - name: Deploy Frontend to Amazon ECS
        run: |
          # 프론트엔드 전용 작업 정의 다운로드
          TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition $ECS_FRONTEND_TASK_DEFINITION --query taskDefinition)

          # 프론트엔드 컨테이너의 새 이미지 주소로 교체
          NEW_TASK_DEF_JSON=$(echo $TASK_DEF_JSON | \
            jq --arg IMAGE_FRONTEND "${{ needs.build-frontend.outputs.image_uri }}" \
               --arg CONTAINER_FRONTEND "$CONTAINER_FRONTEND_NAME" \
               '( .containerDefinitions[] | select(.name == $CONTAINER_FRONTEND) ).image = $IMAGE_FRONTEND')
          
          # 등록에 필요한 키만 추출
          NEW_TASK_DEF_INPUT=$(echo $NEW_TASK_DEF_JSON | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .cpu, .memory)')

          # 새 작업 정의 등록
          NEW_REVISION_ARN=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF_INPUT" | jq -r '.taskDefinition.taskDefinitionArn')
          
          # 프론트엔드 서비스 업데이트
          aws ecs update-service \
            --cluster $ECS_CLUSTER_NAME \
            --service $ECS_FRONTEND_SERVICE_NAME \
            --task-definition $NEW_REVISION_ARN
