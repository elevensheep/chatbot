name: CI/CD Pipeline to AWS ECS

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_BACKEND_REPOSITORY: chatbot-backend
  ECR_FRONTEND_REPOSITORY: chatbot-frontend
  ECS_CLUSTER_NAME: chatbot-ec2-cluster
  ECS_SERVICE_NAME: chatbot-service
  ECS_TASK_DEFINITION: chatbot-task-definition
  CONTAINER_BACKEND_NAME: backend-container
  CONTAINER_FRONTEND_NAME: frontend-container

permissions:
  id-token: write
  contents: read

jobs:

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run backend tests
        run: |
          cd backend
          pytest -q || exit 1

  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      backend_image: ${{ steps.out_backend.outputs.uri }}
      frontend_image: ${{ steps.out_frontend.outputs.uri }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build backend
        id: backend
        uses: docker/build-push-action@v5
        with:
          context: backend
          push: true
          tags: ${{ steps.amazon-ecr-login.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:${{ github.sha }}

      - id: out_backend
        run: echo "uri=${{ steps.amazon-ecr-login.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build frontend
        id: frontend
        uses: docker/build-push-action@v5
        with:
          context: frontend
          push: true
          tags: ${{ steps.amazon-ecr-login.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:${{ github.sha }}

      - id: out_frontend
        run: echo "uri=${{ steps.amazon-ecr-login.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update task definition
        id: update
        run: |
          TASK=$(aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query taskDefinition)

          NEW_TASK=$(echo "$TASK" | jq \
            --arg BACK "${{ needs.build.outputs.backend_image }}" \
            --arg FRONT "${{ needs.build.outputs.frontend_image }}" '
              .containerDefinitions |=
              map(if .name == "backend-container" then .image = $BACK elif .name == "frontend-container" then .image = $FRONT else . end)
            ')

          echo "$NEW_TASK" > new-task.json

          ARN=$(aws ecs register-task-definition --cli-input-json file://new-task.json \
            --query taskDefinition.taskDefinitionArn --output text)

          echo "arn=$ARN" >> $GITHUB_OUTPUT

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER_NAME }} \
            --service ${{ env.ECS_SERVICE_NAME }} \
            --task-definition ${{ steps.update.outputs.arn }}